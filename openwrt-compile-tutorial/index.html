<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenWrt编译教学 | 小辉的折腾天地</title>

  <!-- 引入 CSS 样式 -->
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/header.css">
  <link rel="stylesheet" href="/assets/css/footer.css">
  <link rel="stylesheet" href="/assets/css/post.css">
  <link rel="stylesheet" href="/assets/css/friends.css">
  <link rel="stylesheet" href="/assets/css/blog.css">
  <link rel="stylesheet" href="/assets/css/index.css">

  <!-- 代码高亮样式 -->
  <link rel="stylesheet" href="/assets/css/code-highlight.css">

  <!-- 国内Font Awesome镜像 -->
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/7.0.0/css/all.min.css">

  <!-- === 图片点击放大功能 === -->
  <script src="https://cdn.bootcdn.net/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js"></script>

  <!-- 网站图标 -->
  
  <link rel="icon" 
        href="https://cdn.tungchiahui.cn/tungwebsite/assets/images/favicon.webp">

  <!-- Vercount 网站访问统计 -->
  <script defer src="https://events.vercount.one/js"></script>

</head>

  <body>
    <header class="site-header">

  <!-- 内容层 -->
  <div class="header-content">
    <h1><a href="/">小辉的折腾天地</a></h1>
    <nav>
      <ul>
        <li><a href="/">首页</a></li>
        <li><a href="/blog/">博客</a></li>
        <li><a href="/cv/">简历</a></li>
        <li><a href="/friends/">友链</a></li>
        <li><a href="/about/">关于</a></li>
      </ul>
    </nav>
  </div>
</header>

    <main>
      <article class="post-main">
  <h2>OpenWrt编译教学</h2>
  <p>
    <small>
      发布于 2021-09-16 | 作者: Tung Chia-hui | 阅读次数：<span id="vercount_value_page_pv">Loading</span> 次
    </small>
  </p>
  <div class="post-content">
    <ul id="markdown-toc">
  <li><a href="#编译环境准备" id="markdown-toc-编译环境准备">编译环境准备</a>    <ul>
      <li><a href="#环境说明" id="markdown-toc-环境说明">环境说明</a></li>
      <li><a href="#基础编译过程" id="markdown-toc-基础编译过程">基础编译过程</a></li>
    </ul>
  </li>
  <li><a href="#还有个" id="markdown-toc-还有个">还有个</a>    <ul>
      <li><a href="#重新配置" id="markdown-toc-重新配置">重新配置</a></li>
      <li><a href="#编译更换其它cpu架构的固件建议操作" id="markdown-toc-编译更换其它cpu架构的固件建议操作">编译更换其它CPU架构的固件（建议操作）</a></li>
    </ul>
  </li>
  <li><a href="#个性化配置" id="markdown-toc-个性化配置">个性化配置</a>    <ul>
      <li><a href="#修改默认主题" id="markdown-toc-修改默认主题">修改默认主题</a>        <ul>
          <li><a href="#个性化主题" id="markdown-toc-个性化主题">个性化主题</a></li>
          <li><a href="#个性化主机名" id="markdown-toc-个性化主机名">个性化主机名</a></li>
          <li><a href="#自定义默认密码" id="markdown-toc-自定义默认密码">自定义默认密码</a></li>
          <li><a href="#终端横幅" id="markdown-toc-终端横幅">终端横幅</a></li>
          <li><a href="#无线更改" id="markdown-toc-无线更改">无线更改</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#插件开发" id="markdown-toc-插件开发">插件开发</a>    <ul>
      <li><a href="#插件源码的文件组成" id="markdown-toc-插件源码的文件组成">插件源码的文件组成</a>        <ul>
          <li><a href="#创建构建文件makefile" id="markdown-toc-创建构建文件makefile">创建构建文件Makefile</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#补充工具" id="markdown-toc-补充工具">补充工具</a>    <ul>
      <li><a href="#修改接口mac地址" id="markdown-toc-修改接口mac地址">修改接口MAC地址</a></li>
    </ul>
  </li>
  <li><a href="#其他参考资料" id="markdown-toc-其他参考资料">其他参考资料</a></li>
</ul>

<h1 id="编译环境准备">编译环境准备</h1>

<h2 id="环境说明">环境说明</h2>
<p>本教程以乌班图22.04作为环境
请确保编译过程全局魔法</p>

<h2 id="基础编译过程">基础编译过程</h2>

<p>设置环境变量（不知道有没有用）：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>注意使用root编译会报错，可以在/etc/profile 最后添加export <span class="nv">FORCE_UNSAFE_CONFIGURE</span><span class="o">=</span>1,然后执行
<span class="nb">export </span><span class="nv">FORCE_UNSAFE_CONFIGURE</span><span class="o">=</span>1
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>系统软件包更新
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nt">-y</span> update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nt">-y</span> upgrade
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>安装依赖关系与编译工具链
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> ack antlr3 aria2 asciidoc autoconf automake autopoint binutils bison build-essential <span class="se">\</span>
bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib <span class="se">\</span>
git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev <span class="se">\</span>
libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz <span class="se">\</span>
mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip libpython3-dev qemu-utils <span class="se">\</span>
rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>下载 OpenWrt 源码
```bash
git clone https://github.com/openwrt/openwrt.git &amp;&amp; cd openwrt 
git clone https://github.com/coolsnowwolf/lede &amp;&amp; cd lede</li>
</ol>

<h1 id="还有个">还有个</h1>
<p>git clone https://github.com/istoreos/istoreos</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
（源码有很多，本教程以官方源码和LEDE为例） 

4. 切换适合分支 

openwrt-22.03 已将 iptables 移除，为避免兼容性问题，暂时切换到 openwrt-21.02分支: 
```bash
git checkout openwrt-21.02
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>更新并安装 feeds 软件源
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>./scripts/feeds update <span class="nt">-a</span> <span class="o">&amp;&amp;</span> ./scripts/feeds <span class="nb">install</span> <span class="nt">-a</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>（以下为校园网防检测部署）</p>

<ol>
  <li>加入模块
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>git clone https://github.com/Zxilly/UA2F.git package/UA2F
git clone https://github.com/CHN-beta/rkp-ipid.git package/rkp-ipid 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>配置编辑
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make menuconfig
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>配置编译 rdp-ipid:</p>
<ul>
  <li>Kernel modules → Other modules → kmod-rkp-ipid</li>
</ul>

<p>配置编译 ua2f:</p>
<ul>
  <li>Network → Routing and Redirection → UA2F</li>
</ul>

<p>配置编译 iptables 模块（Firewall中）</p>

<p>选中：</p>
<ul>
  <li>iptables-mod-filter</li>
  <li>iptables-mod-ipopt</li>
  <li>iptables-mod-u32</li>
</ul>

<p>基本界面配置：</p>
<ul>
  <li>LuCI → Collections → luci （lede 默认已选）</li>
  <li>LuCI → Modules → Translations → Chinese Simplified (zh_Hans) （lede 默认已选）</li>
  <li>LuCI → Modules → luci-compat</li>
  <li>LuCI → Applications → luci-app-ttyd（网页终端）</li>
  <li>LuCI → Themes → xxxxx (根据需要自己选管理界面的主题，如果路由器储存太小，建议就维持默认的)</li>
</ul>

<p>其他配置：</p>
<ul>
  <li>添加EXT4硬盘格式支持：Kernel modules &gt; Filesystem &gt; kmod-fs-ext4</li>
  <li>添加USB支持（如不添加可能会不响应键盘）：Kernel modules &gt; USB Support</li>
</ul>

<p>网卡驱动配置：</p>
<ul>
  <li>经查找网卡使用的是Intel IG211-AT，走的是PCIE通道，这里要选用e1000e</li>
  <li>Kernel modules &gt; Network Devices将kmod-e1000e，kmod-igb驱动选中</li>
</ul>

<p>无线网卡驱动：</p>
<ul>
  <li>内核中的无线驱动找到RTL8821AE的驱动</li>
  <li>Kernel modules &gt; Wireless Drivers</li>
</ul>

<blockquote>
  <p>作者：KANSUNG
链接：https://www.jianshu.com/p/5190ab903820
来源：简书</p>
</blockquote>

<p>添加其他工具（可选）：</p>
<ul>
  <li>LuCI &gt; Applications -&gt; luci-app-openclash</li>
  <li>LuCI &gt; Applications -&gt; luci-app-adblock</li>
  <li>LuCI &gt; Applications -&gt; luci-app-ddns-go</li>
</ul>

<p>添加必要组件：</p>
<ul>
  <li>Kernel modules -&gt; Network Support -&gt; kmod-tun （openclash TUN模式必须）</li>
</ul>

<p>排除冲突组件：</p>
<ul>
  <li>Base system -&gt; dnsmasq (取消勾选，因为默认会安装dnsmasq-full，需要排除dnsmasq避免冲突报错）</li>
</ul>

<p>编辑配置文件：</p>
<ul>
  <li>使用 vim .config，在开头添加一行（UA2F 插件需要）：
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">CONFIG_NETFILTER_NETLINK_GLUE_CT</span><span class="o">=</span>y
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>编译和配置内核
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>make kernel_menuconfig
make <span class="nt">-j1</span> <span class="nv">V</span><span class="o">=</span>sc kernel_menuconfig  <span class="c"># 日志更详细</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>配置路径：
Networking support →
  Networking options →
    Network packet filtering framework (Netfilter) （要先选中再进去）→
      Core Netfilter Configuration →</p>

<p>选中以下选项：</p>
<ul>
  <li>Netfilter NFNETLINK interface</li>
  <li>Netfilter LOG over NFNETLINK interface</li>
  <li>Netfilter connection tracking support</li>
  <li>Connection tracking netlink interface</li>
  <li>NFQUEUE and NFLOG integration with Connection Tracking</li>
</ul>

<ol>
  <li>编译
下载编译工具：
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make download <span class="nt">-j</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="nv">V</span><span class="o">=</span>s
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<p>开始编译：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>make <span class="nt">-j</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="nv">V</span><span class="o">=</span>s
make <span class="nt">-j1</span> <span class="nv">V</span><span class="o">=</span>sc 2&gt; build.log  <span class="c"># 错误输出到日志</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>二次编译需要更新源码：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git pull
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="重新配置">重新配置</h3>
<p>如果需要重新配置：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nb">rm</span> <span class="nt">-rf</span> ./tmp <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> .config
make menuconfig
make <span class="nt">-j</span><span class="k">$((</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span> <span class="nv">V</span><span class="o">=</span>s   <span class="c"># 多线程编译失败后自动进入单线程编译，失败则输出详细日志</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="编译更换其它cpu架构的固件建议操作">编译更换其它CPU架构的固件（建议操作）</h3>

<p>清除旧的编译产物：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make clean
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>在源码有大规模更新或者内核更新后执行，以保证编译质量。此操作会删除/bin和/build_dir目录中的文件。</p>
</blockquote>

<p>清除旧的编译产物、交叉编译工具及工具链等目录：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make dirclean
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>更换架构编译前必须执行。此操作会删除/bin和/build_dir目录的中的文件(make clean)以及/staging_dir、/toolchain、/tmp和/logs中的文件。</p>
</blockquote>

<p>清除 OpenWrt 源码以外的文件（可选）：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>make distclean
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>除非是做开发，并打算 push 到 GitHub 这样的远程仓库，否则几乎用不到。此操作相当于make dirclean外加删除/dl、/feeds目录和.config文件。</p>
</blockquote>

<p>还原 OpenWrt 源码到初始状态（可选）：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>git clean <span class="nt">-xdf</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>如果把源码改坏了，或者长时间没有进行编译时使用。</p>
</blockquote>

<p>清除临时文件：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">rm</span> <span class="nt">-rf</span> tmp
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>删除执行make menuconfig后产生的一些临时文件，包括一些软件包的检索信息，删除后会重新加载package目录下的软件包。若不删除会导致一些新加入的软件包不显示。</p>
</blockquote>

<p>删除编译配置文件：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">rm</span> <span class="nt">-f</span> .config
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>在不删除的情况下如果取消选择某些组件它的依赖组件不会自动取消，所以对于需要调整组件的情况下建议删除。</p>
</blockquote>

<p>注意：所有操作不要使用root用户</p>

<blockquote>
  <p>版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。</p>

  <p>原文链接：https://blog.csdn.net/u010674953/article/details/129280724</p>
</blockquote>

<h1 id="个性化配置">个性化配置</h1>

<h2 id="修改默认主题">修改默认主题</h2>
<p>进入路径<code class="language-plaintext highlighter-rouge">openwrt/feeds/luci/collections/luci</code>，修改<code class="language-plaintext highlighter-rouge">Makefile</code>（适用于openwrt版本19.07，不同的版本，会稍微不同）：</p>
<ul>
  <li>将LUCI_DESCRIPTION中，bootstrap 替换为 argon</li>
  <li>将LUCI_DEPENDS中，+luci-theme-bootstrap 替换为 +luci-theme-argon</li>
</ul>

<p>原文链接：https://blog.csdn.net/pyt1234567890/article/details/107442792</p>

<h4 id="个性化主题">个性化主题</h4>
<p>以 “argon”主题为例，可编辑性强要更改OpenWrt源码中的主题，包括Argon主题，可以按照以下步骤操作：</p>

<ol>
  <li>进入<code class="language-plaintext highlighter-rouge">feeds/luci/themes/</code>目录</li>
  <li>找到Argon主题所在的目录（一般为<code class="language-plaintext highlighter-rouge">luci-theme-argon</code>），并进入该目录</li>
  <li>打开<code class="language-plaintext highlighter-rouge">root/usr/share/luci/static/resources/view/themes/argon/header.htm</code>文件，该文件定义了Argon主题的顶部导航栏、LOGO等内容</li>
  <li>在header.htm文件中找到需要修改的内容，并进行相应的编辑和保存。例如，将LOGO图片路径指向自己的图片文件，或者调整导航栏的布局和样式</li>
  <li>如果需要修改Argon主题的其他部分，例如底部导航栏、颜色方案等，可以在<code class="language-plaintext highlighter-rouge">root/usr/share/luci/static/resources/view/themes/argon/</code>目录下找到对应的文件进行编辑</li>
</ol>

<h4 id="个性化主机名">个性化主机名</h4>
<p>修改<code class="language-plaintext highlighter-rouge">package/base-files/files/bin/config_generate</code>，将<code class="language-plaintext highlighter-rouge">"OpenWrt"</code>替换</p>

<h4 id="自定义默认密码">自定义默认密码</h4>
<p>修改passwd文件</p>

<h4 id="终端横幅">终端横幅</h4>
<p>修改文件：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>./package/base-files/files/etc/banner
</pre></td></tr></tbody></table></code></pre></div></div>
<p>横幅生成地址：http://www.network-science.de/ascii/</p>

<h4 id="无线更改">无线更改</h4>
<p>修改文件：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>/package/kernel/mac80211/files/lib/wifi/mac80211.sh    <span class="c"># (ssid)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改自定义版本号：openwrt_release</p>

<h1 id="插件开发">插件开发</h1>

<h2 id="插件源码的文件组成">插件源码的文件组成</h2>
<p>Openwrt插件一般使用”MVC”结构：</p>

<ol>
  <li>配置文件
位于 <code class="language-plaintext highlighter-rouge">/etc/config/*</code>：
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>config server
option username ''
option password ''
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>例示文件中生成了两个待输入的配置。现在需要一个表单页面来管理它。</p>
  </li>
  <li>CBI文件
一般位于目录 <code class="language-plaintext highlighter-rouge">/usr/lib/lua/luci/model/cbi/*.lua</code>：</li>
</ol>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="nb">require</span><span class="p">(</span><span class="s2">"luci.sys"</span><span class="p">)</span>

<span class="c1">-- 页面标题和描述</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="s2">"bargo"</span><span class="p">,</span> <span class="n">translate</span><span class="p">(</span><span class="s2">"Bargo Client"</span><span class="p">),</span> <span class="n">translate</span><span class="p">(</span><span class="s2">"Configure Bargo client, Powered By Sinchie."</span><span class="p">))</span>

<span class="c1">-- 读取配置文件</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="p">:</span><span class="n">section</span><span class="p">(</span><span class="n">TypedSection</span><span class="p">,</span> <span class="s2">"server"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="n">addremove</span> <span class="o">=</span> <span class="kc">false</span>
<span class="n">s</span><span class="p">.</span><span class="n">anonymous</span> <span class="o">=</span> <span class="kc">true</span>

<span class="c1">-- 是否启用的选择框</span>
<span class="n">enable</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">option</span><span class="p">(</span><span class="n">Flag</span><span class="p">,</span> <span class="s2">"enable"</span><span class="p">,</span> <span class="n">translate</span><span class="p">(</span><span class="s2">"Enable"</span><span class="p">))</span>
<span class="c1">-- 映射我们的配置到输入框</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">option</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="s2">"username"</span><span class="p">,</span> <span class="n">translate</span><span class="p">(</span><span class="s2">"Username"</span><span class="p">))</span>
<span class="n">pass</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">option</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">,</span> <span class="n">translate</span><span class="p">(</span><span class="s2">"Password"</span><span class="p">))</span>
<span class="n">pass</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="kc">true</span>

<span class="c1">-- 如果点击了保存按钮</span>
<span class="kd">local</span> <span class="n">apply</span> <span class="o">=</span> <span class="n">luci</span><span class="p">.</span><span class="n">http</span><span class="p">.</span><span class="n">formvalue</span><span class="p">(</span><span class="s2">"cbi.apply"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">apply</span> <span class="k">then</span>
    <span class="c1">-- 这里是调用我们自己的程序脚本，后面会讲怎么来写这个脚本</span>
    <span class="nb">io.popen</span><span class="p">(</span><span class="s2">"/etc/init.d/bargo restart &gt; /dev/null &amp;"</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">m</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>控制器文件
一般位于系统的<code class="language-plaintext highlighter-rouge">/usr/lib/lua/luci/controller/*.lua</code>，创建控制器文件后可以在web界面创建一个界面入口（菜单）。脚本结构如下：</li>
</ol>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">-- module 名称</span>
<span class="n">module</span><span class="p">(</span><span class="s2">"luci.controller.bargo"</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">seeall</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="c1">-- 4 个参数介绍</span>
    <span class="c1">-- 1.后台访问路径 admin/services/bargo </span>
    <span class="c1">-- 2.target 动作（call, template, cbi）call 是调用自定义函数，template 调用 html 模板，cbi 调用 openwrt 的公共表单页面</span>
    <span class="c1">-- 3.菜单名称 </span>
    <span class="c1">-- 4.排序</span>
    <span class="n">entry</span><span class="p">({</span><span class="s2">"admin"</span><span class="p">,</span> <span class="s2">"services"</span><span class="p">,</span> <span class="s2">"bargo"</span><span class="p">},</span> <span class="n">cbi</span><span class="p">(</span><span class="s2">"bargo"</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s2">"Bargo Client"</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="创建构建文件makefile">创建构建文件Makefile</h4>

<p>制作 OpenWRT 编译 Makefile 文件需要以下步骤：</p>

<ol>
  <li>安装 OpenWRT SDK，并设置环境变量</li>
  <li>在任意目录下，创建一个新的文件夹，用于存放你的应用程序代码</li>
  <li>在该目录下，创建 <code class="language-plaintext highlighter-rouge">Makefile</code> 文件，并按照以下结构填写相应内容：</li>
</ol>

<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre>
<span class="c"># 这是注释，可以忽略或者修改
</span>
<span class="k">include</span><span class="sx"> $(TOPDIR)/rules.mk</span> <span class="c"># 引入OpenWRT编译规则
</span><span class="nv">PKG_NAME</span><span class="o">:=</span>myapp <span class="c"># 应用程序的名称，建议使用小写字母和数字组合</span>
<span class="nv">PKG_VERSION</span><span class="o">:=</span>1.0 <span class="c"># 应用程序的版本号</span>
<span class="nv">PKG_RELEASE</span><span class="o">:=</span>1 <span class="c"># 应用程序的发行版本号</span>

<span class="k">include</span><span class="sx"> $(INCLUDE_DIR)/package.mk</span> <span class="c"># 引入OpenWRT中提供的软件包模板
</span><span class="k">define</span> <span class="nv">Package/myapp </span><span class="c"># 描述应用程序的信息
</span>  <span class="nv">SECTION</span><span class="o">:=</span>net
  <span class="nv">CATEGORY</span><span class="o">:=</span>Network
  <span class="nv">TITLE</span><span class="o">:=</span>My Application
  <span class="nv">DEPENDS</span><span class="o">:=</span>+libopenssl +libcurl +libjson-c 
<span class="k">endef</span>

<span class="k">define</span> <span class="nv">Package/myapp/description </span><span class="c"># 描述应用程序功能和用途
</span> <span class="err">My</span> <span class="err">Application</span> <span class="err">is</span> <span class="err">a</span> <span class="err">simple</span> <span class="err">program</span> <span class="err">that</span> <span class="err">does</span> <span class="err">something</span> <span class="err">useful.</span>
<span class="k">endef</span>

<span class="k">define</span> <span class="nv">Build/Prepare </span><span class="c"># 准备构建应用程序所需的源码和资源
</span>
<span class="c"># 此处可以添加自定义命令，用于准备应用程序的源码和资源
</span><span class="k">endef</span>

<span class="k">define</span> <span class="nv">Build/Configure </span><span class="c"># 配置应用程序的编译选项
</span>
<span class="c"># 此处可以添加自定义命令，用于配置应用程序的编译选项
</span><span class="k">endef</span>

<span class="k">define</span> <span class="nv">Build/Compile </span><span class="c"># 编译应用程序的源码
</span>
<span class="c"># 此处可以添加自定义命令，用于编译应用程序的源码
</span><span class="k">endef</span>

<span class="k">define</span> <span class="nv">Package/myapp/install </span><span class="c"># 安装应用程序所需的文件和目录
</span><span class="err">$(INSTALL_DIR)</span> <span class="err">$(1)/usr/bin</span> <span class="c"># 创建安装目录
</span><span class="err">$(INSTALL_BIN)</span> <span class="err">$(PKG_BUILD_DIR)/myapp</span> <span class="err">$(1)/usr/bin/</span> <span class="c"># 安装二进制文件
</span><span class="k">endef</span>

<span class="nf">$(</span><span class="nb">eval</span> <span class="p">$(</span>call BuildPackage,myapp<span class="p">))</span> <span class="c"># 构建软件包并注册到OpenWRT中
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="补充工具">补充工具</h1>

<h2 id="修改接口mac地址">修改接口MAC地址</h2>
<p>修改MAC地址：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>uci <span class="nb">set </span>network.cfg050f15.macaddr<span class="o">=</span><span class="s1">'98:8F:E0:67:44:86'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>保存更改：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>uci commit network
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="其他参考资料">其他参考资料</h1>
<p>添加USB和硬盘格式还有网卡教程：
https://www.jianshu.com/p/5190ab903820</p>

  </div>
</article>

<script>
// 页面内容加载完成后执行
document.addEventListener("DOMContentLoaded", function() {

  const imgs = document.querySelectorAll('.post-content img');

  imgs.forEach(img => {
    // 如果图片还没有 data-src，就把 src 移过去
    if (!img.dataset.src) {
      img.dataset.src = img.src; 
      img.removeAttribute('src'); 
    }
  });

  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;

        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');

          // ✅ 新增：当图片真正加载完成后，触发自定义事件
          img.addEventListener('load', () => {
            const event = new CustomEvent('lazyloaded', { detail: { img } });
            document.dispatchEvent(event);
          }, { once: true });
        }

        obs.unobserve(img);
      }
    });
  }, {
    root: null,           
    rootMargin: '666px 0px',
    threshold: 0          
  });

  imgs.forEach(img => observer.observe(img));
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('div[class*="language-"].highlighter-rouge').forEach((highlightDiv) => {
    const codePre = highlightDiv.querySelector('td.rouge-code pre');
    if (!codePre) return;

    // 创建复制按钮
    const button = document.createElement('button');
    button.className = 'copy-button';
    button.type = 'button';
    button.innerText = '复制';

    button.addEventListener('click', () => {
      const text = codePre.innerText.trim();
      navigator.clipboard.writeText(text).then(() => {
        button.innerText = '已复制';
        setTimeout(() => button.innerText = '复制', 2000);
      });
    });

    // 挂到 highlightDiv 上，保证按钮固定在代码框右上角
    highlightDiv.style.position = 'relative';   // 父容器相对定位
    button.style.position = 'absolute';
    button.style.top = '8px';
    button.style.right = '8px';
    button.style.padding = '4px 8px';
    button.style.fontSize = '0.8em';
    button.style.cursor = 'pointer';

    highlightDiv.appendChild(button);
  });
});
</script>

<!-- === 图片点击放大效果 === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 选择文章正文内所有图片
  const images = document.querySelectorAll('.post-content img');

  // 过滤掉代码块或表格中不需要放大的图片
  const validImages = Array.from(images).filter(img => {
    return !img.closest('pre, code, table');
  });

  // 初始化 Medium Zoom
  const zoom = mediumZoom(validImages, {
    margin: 24, // 放大时边距
    background: 'rgba(0,0,0,0.8)', // 背景遮罩色
    scrollOffset: 40 // 滚动多少距离后关闭放大
  });

  // 如果页面启用了懒加载，当懒加载触发时重新绑定放大事件
  document.addEventListener('lazyloaded', () => {
    zoom.detach(); // 先解除旧绑定
    zoom.attach('.post-content img'); // 重新绑定新加载的图片
  });
});
</script>




    </main>

    <footer>
  <p>© 2025 小辉的折腾天地. All rights reserved.</p>

  <!-- 社交图标 -->
  <div class="footer-social">
    
      <a href="https://me.tungchiahui.cn" target="_blank" rel="noopener" title="Website">
        <i class="fas fa-link"></i>
      </a>
    
    
      <a href="mailto:tungchiahui@gmail.com" target="_blank" rel="noopener" title="E-Mail">
        <i class="fas fa-envelope"></i>
      </a>
    
    
      <a href="https://github.com/tungchiahui" target="_blank" rel="noopener" title="GitHub">
        <i class="fab fa-github"></i>
      </a>
    
    
      <a href="https://qm.qq.com/q/JRhksaNK82?from=qq" target="_blank" rel="noopener" title="QQ">
        <i class="fab fa-qq"></i>
      </a>
    
    
      <a href="https://t.me/tungchiahui" target="_blank" rel="noopener" title="Telegram">
        <i class="fab fa-telegram"></i>
      </a>
    
    
      <a href="http://www.coolapk.com/u/3224578" target="_blank" rel="noopener" title="CoolAPK">
        <i class="fab fa-android"></i>
      </a>
    
    
      <a href="https://space.bilibili.com/141482453" target="_blank" rel="noopener" title="Bilibili">
        <i class="fa-brands fa-bilibili"></i>
      </a>
    
    
      <a href="https://www.youtube.com/@Chia-huiTung" target="_blank" rel="noopener" title="YouTube">
        <i class="fab fa-youtube"></i>
      </a>
    
    
      <a href="https://twitter.com/tungchiahui" target="_blank" rel="noopener" title="Twitter">
        <i class="fab fa-twitter"></i>
      </a>
    
    
      <a href="https://www.facebook.com/tungchiahui" target="_blank" rel="noopener" title="Facebook">
        <i class="fab fa-facebook"></i>
      </a>
    
    
      <a href="https://www.instagram.com/tungchiahui" target="_blank" rel="noopener" title="Instagram">
        <i class="fab fa-instagram"></i>
      </a>
    
  </div>

  <div class="footer-records">
    <!-- ICP 备案号 -->
    
    <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener" class="footer-record icp">
      <img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/footer/favicon-miit.ico" alt="工信部图标">
      鲁ICP备2025185601号-2
    </a>
    

     <!-- 公安备案号 -->
    
    <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=xxxxxxxxxxx" target="_blank" rel="noopener" class="footer-record beian">
      <img src="https://cdn.tungchiahui.cn/tungwebsite/assets/images/footer/favicon-mps.ico" alt="公安备案图标">
      鲁公网安备 xxxxxxxxxxx 号
    </a>
    
  </div>


</footer>


    <!-- 这才是liquild的注释，不能用html的注释 -->
    <!-- 因为liquid会把html的注释也渲染出来 -->
    

  </body>
</html>
